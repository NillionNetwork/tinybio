<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>tinybio: Secure Decentralized Biometric Authentication Demo</title>
    <script>
      var favIcon = "iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAGFBMVEUAAABHcEwAAAAAAAAAAAAAAAAAAAAAAACpMnD0AAAAB3RSTlNjAL+fpPk8rO4B2AAAADNJREFUGJVjYEQDDIxsLMxwwMIGFGBgRwIMOAVYgQBZgAlkHNMgEwB6joUB7E8WiOfQAADiPANLertncwAAAABJRU5ErkJggg==";
      var docHead = document.getElementsByTagName('head')[0];
      var newLink = document.createElement('link');
      newLink.rel = 'shortcut icon';
      newLink.type = 'image/x-icon';
      newLink.href = 'data:image/png;base64,'+favIcon;
      docHead.appendChild(newLink);
    </script>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@300;400;500;700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
      html { height:100vh; }
      body { display:flex; flex-direction:column; min-height:100vh; padding:0px 0px 0px 0px; font-family:'Cabin',sans-serif; }
      @media (min-width: 768px) { html { font-size:16px; } }
      a { color:#0000FF; font-weight:bold; text-decoration:none; }
      a:hover { text-decoration:none; color:#000000; }
      #header { min-height:100px; margin-top:60px; margin-bottom:20px; }
      .space { margin-top:30px; }
      hr { height:1px !important; margin:0px; border-top:1px solid #000000 !important; opacity:1; }
      h1 { text-align:left; }
      h2 { margin-top:10px; line-height:21px; font-size:18px; font-weight:normal; }
      h3 {
        width:100%;
        margin-bottom:0px;
        padding:4px 10px 6px 10px;
        border-top:1px solid #000000; border-left:1px solid #000000; border-right:1px solid #000000;
        text-align:left;
        font-size:22px;
      }
      .container > .row { margin-bottom:8px; }
      .grid-row { display:grid; grid-auto-rows:auto; grid-row-gap:0px; grid-column-gap:0px; }
      .grid-row-clients { grid-template-columns:3fr 4.5fr 4.5fr; }
      .grid-row-connectors { grid-template-columns:3fr 9fr; }
      .grid-row-nodes { grid-template-columns:3fr 3fr 3fr 3fr; }
      .grid-row-result { grid-template-columns:3fr 9fr; }
      .grid-col { padding:6px; }
      .guide > ol > li { margin-left:8px; font-size:42px; font-weight:bold; }
      .guide > ol > li > div {
        position:relative;
        top:-16px;
        padding-right:8px;
        line-height:21px; 
        font-size:18px; font-weight:normal;
      }
      .content { width:100%; margin:0px 10px 0px 0px; padding:4px 10px 4px 10px; text-align:left; }
      .entity { margin-top:0px; padding:20px 24px 20px 24px; border:1px solid #000000; }
      .node > h3 { background-color:#0000FF; color:#FFFFFF; }
      .node > .entity { border-top:1px solid #FFFFFF; background-color:#0000FF; color:#FFFFFF; }
      .activated > h3 { background-color:#000000; color:#FFFFFF; }
      .activated > .entity { border-top:1px solid #FFFFFF; background-color:#000000; color:#FFFFFF; }
      .clickable { cursor:pointer; }
      .clickable:hover > h3 { background-color:#000000; color:#FFFFFF; }
      .clickable:hover > .entity { border-top:1px solid #FFFFFF; background-color:#000000; color:#FFFFFF; }
      img { width:100%; border:1px solid #FFFFFF; }
      .raw { display:inline-block; width:100%; overflow:hidden; word-break: break-word; word-wrap:break-word; font-family:Monospace; font-size:10px; }
      .client { padding-top:0px; }
      .client .raw { aspect-ratio:1; }
      .box-title {
        width:100%;
        margin-top:16px;
        margin-bottom:10px;
        text-align:center;
        font-size:14px;
        font-weight:bold;
        line-height:16px !important;
      }
      .data-box {
        border:1px solid #000000;
        text-align:center;
        vertical-align:middle;
      }
      .data-box > div {
        height:100%;
        display:flex;
        align-items:center;
        padding:20px;
        font-size:10px;
        color:#999999;
      }
      .data-box > img {
        border:4px solid #FFFFFF;
      }
      .data-box > img:hover {
        border:4px solid #0000FF;
      }
      .action {
        margin-top:20px;
      }
      .file-choose {
        width:100%;
        margin:0px 2px 2px 0px;
        -webkit-box-shadow: 2px 2px 0px 0px #555555;
        -moz-box-shadow: 2px 2px 0px 0px #555555;
        box-shadow: 2px 2px 0px 0px #555555;
        padding:8px;
        border:0px solid #000000;
        background-color:#0000FF;
        text-align:center;
        color:#FFFFFF;
        cursor:pointer;
      }
      .file-choose:hover {
        background-color:#000000;
      }
      .file-choose:active {
        margin:2px 0px 0px 2px;
        -webkit-box-shadow: 0px 0px 0px 0px #555555;
        -moz-box-shadow: 0px 0px 0px 0px #555555;
        box-shadow: 0px 0px 0px 0px #555555;
      }
      button {
        width:100%;
        margin:0px 2px 2px 0px;
        -webkit-box-shadow: 2px 2px 0px 0px #555555;
        -moz-box-shadow: 2px 2px 0px 0px #555555;
        box-shadow: 2px 2px 0px 0px #555555;
        padding:8px;
        border:0px solid #000000;
        background-color:#0000FF;
        color:#FFFFFF;
      }
      button:hover {
        background-color:#000000;
      }
      button:active {
        margin:2px 0px 0px 2px;
        -webkit-box-shadow: 0px 0px 0px 0px #555555;
        -moz-box-shadow: 0px 0px 0px 0px #555555;
        box-shadow: 0px 0px 0px 0px #555555;
      }
      #result-bar {
        min-width:10%; height:100px;
        margin-top:0px;
        padding:20px;
        background-color:#FFFFFF;
        text-align:center;
        font-size:40px;
        color:#FFFFFF;
      }
      .connectors { height:100px; margin:0px !important; padding:0px; width:100%; height:100%;}
      canvas { width:100%; height:100px; }
      .card-deck .card { border:0px; min-width:220px; }
      .card { min-width:350px !important; }
      .card-body { padding:2px 10px 2px 10px; line-height:18px; font-size:14px; }
      footer { width:100%; margin:auto auto 0 auto; padding:16px 0px 16px 0px; background-color:#000000; color:#FFFFFF; }
      footer a { color:#FFFFFF; }
      footer a:hover { color:#FFFFFF; }
      footer .card-deck { margin-bottom:0px !important; }
      footer .card { margin-bottom:0px !important; border:0px; background-color:#000000; }
      footer .card-body-items { padding:8px 20px 0px 20px; }
      footer .card-body-items-left { float:left; }
      footer .card-body-items-right { float:right; }
      footer .card-deck-copyright { height:26x !important; font-size:10px; }
      footer .card-copyright { height:26px !important; padding:0px 16px 0px 16px; font-size:12px !important; }
      footer .license-phrase { color:#FFFFFF; }
      footer .item { margin:0px 25px 0px 0px; white-space: nowrap; font-size:14px; }
      footer .icon { margin:0px 15px 0px 0px; font-size:20px; }
      footer .icon-last { margin:0px 0px 0px 0px; font-size:18px; }
      .noselect {
        -webkit-touch-callout:none; /* iOS Safari */
          -webkit-user-select:none; /* Safari */
           -khtml-user-select:none; /* Konqueror HTML */
             -moz-user-select:none; /* Old versions of Firefox */
              -ms-user-select:none; /* Internet Explorer/Edge */
                  user-select:none; /* Non-prefixed version, currently
                                       supported by Chrome, Edge, Opera and Firefox */
      }
      #imageUploader {max-width: 100%;}
      @media all and (max-width:900px) {
        .client .raw { /* display:none; */ }
        .client > .row > .col-xs-6 { /* width:100%; */ }
      }
      @media all and (max-width:618px) {
        #header { margin-top:50px; }
        #license-phrase { /* display:none; */ }
      }
      @media all and (max-width:575px) {
        .client > .row > .col { flex:0 0 auto !important; }
      }
      @media all and (max-width:400px) {
        .card { min-width:250px !important; }
      }
      @media all and (max-width:320px) { }
    </style>
  </head>
  <body onload="connectors();">
    <div class="container" id="header">
      <div class="card-deck mb-3">
        <div class="card mb-4">
          <div class="card-body">
            <h1><b>tinybio</b>: Secure Decentralized Biometric Authentication Demo</h1>
            <hr/>
            <h2>
              This demo simulates a secure multi-party computation network <b>in your browser</b> by importing and running the <a href="https://github.com/nillion-oss/tinybio">tinybio</a> and underlying <a href="https://github.com/nillion-oss/tinynmc">tinynmc</a> libraries using <a href="https://pyscript.net">PyScript</a>. 
              The <a href="https://github.com/ageitgey/face_recognition">Face Recognition</a> library was used to generate the inputs for each of the images below (the inputs in this demo are fixed because PyScript can only load libraries that are pure Python).
              Click on one of the two <b>Login</b> options to view the computation and output.
            </h2>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="grid-row grid-row-clients">
        <div class="grid-col">
          <div class="guide">
            <div class="guide">
              <ol start="1">
                <li>
                  <div>
                    During both registration and authentication, the image is encoded as a vector, masks are requested from the nodes, and secret shares of the masked image are distributed among the nodes.
                  </div>
                </li>
              </ol>
            </div>
          </div>
        </div>
        <div class="grid-col">
          <div class="content">
            <h3>Registration</h3>
            <div class="entity client">
              <div class="row row-cols-sm-1 row-cols-md-2">
                <div class="col">
                  <div class="box-title">Image Selection</div>
                  <div class="data-box clickable" style="margin-bottom:6px;">
                    <img id="previewImage" src="reg-obama.png" />
                  </div>
                  <label class="file-choose">
                    <input type="file" id="imageUploader" accept="image/*" style="width:100% !important; display:none;" />
                    Choose File
                  </label>
                </div>
                <div class="col">
                  <div class="box-title">Authentication Data</div>
                  <div class="data-box" style="aspect-ratio:1;">
                    <div class="raw" id="auth_obama_register">Please select an image on the left</div>
                  </div>
                </div>
              </div>
              <div class="row row-cols-1 action">
                <div class="col">
                  <button id="register">Mask &amp; Register</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid-col">
          <div id="login-user-a" class="content">
            <h3>Authentication</h3>
            <div class="entity client">
              <div class="row row-cols-sm-1 row-cols-md-2">
                <div class="col">
                  <div class="box-title">Image Selection</div>
                  <div class="row">
                    <div class="col">
                      <div class="data-box clickable">
                        <img id="img-auth-a" src="auth-obama.png" />
                      </div>
                    </div>
                    <div class="col">
                      <div class="data-box clickable">
                        <img id="img-auth-b" src="auth-biden.png" />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col">
                  <div class="box-title">Authentication Data</div>
                  <div class="data-box" style="aspect-ratio:1;">
                    <div class="raw" id="auth_obama_login">Please select an image on the left</div>
                  </div>
                </div>
              </div>
              <div class="row row-cols-1 action">
                <div class="col">
                  <button id="authenticate">Mask &amp; Authenticate</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid-row grid-row-connectors">
        <div class="grid-col"></div>
        <div class="grid-col">
          <div class="col">
            <canvas id="canvas-register-and-login"></canvas>
          </div>
        </div>
      </div>
      <div class="grid-row grid-row-nodes">
        <div class="grid-col">
          <div class="guide">
            <ol start="2">
              <li>
                <div>
                  Each node receives secret shares of the vectors corresponding the two images, and then locally computes its secret share of the overall distance between the two vectors.
                </div>
              </li>
            </ol>
          </div>
        </div>
        <div class="grid-col">
          <div class="content node">
            <h3>Node 1</h3>
            <div class="entity">
              <div class="row row-cols-1">
                <div class="col-xs-6"><div class="raw" id="node-one"></div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid-col">
          <div class="content node">
            <h3>Node 2</h3>
            <div class="entity">
              <div class="row row-cols-1">
                <div class="col-xs-6"><div class="raw" id="node-two"></div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid-col">
          <div class="content node">
            <h3>Node 3</h3>
            <div class="entity">
              <div class="row row-cols-1">
                <div class="col-xs-6"><div class="raw" id="node-three"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid-row grid-row-connectors">
        <div class="grid-col"></div>
        <div class="grid-col">
          <div class="col">
            <canvas id="canvas-reconstruct"></canvas>
          </div>
        </div>
      </div>
      <div class="grid-row grid-row-result">
        <div class="grid-col">
          <div class="guide">
            <ol start="3">
              <li>
                <div>
                  A designated third party receives the secret shares of the result from the nodes and reconstructs the overall output.
                </div>
              </li>
            </ol>
          </div>
        </div>
        <div class="grid-col">
          <div class="content">
            <h3>Network Output</h3>
            <div class="entity">
              <div class="row row-cols-1">
                <div class="col-xs-6">
                  <div id="result-bar"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="space"></div>
    <footer>
      <div class="container noselect">
        <div class="card-deck mb-3">
          <div class="card mb-4">
            <div class="card-body card-body-items">
              <div class="card-body-items-left">
                <span class="item"><span class="license-phrase">Made available under the </span><a href="https://opensource.org/license/mit/">MIT License</a></span>
              </div>
              <div class="card-body-items-right">
                <span class="icon"><a href="mailto:engineering@nillion.com"><i class="far fa-envelope"></i></a></span>
                <span class="icon-last"><a href="https://github.com/nillion-oss"><i class="fab fa-github"></i></a></span>
              </div>
            </div>
          </div>
        </div>
        <div class="card-deck mb-3 card-deck-copyright">
          <div class="card mb-4 card-copyright"></div>
        </div>
      </div>
    </footer>
    <py-config>
      packages = ["tinynmc"]
    </py-config>
    <section class="pyscript">
      <py-script>
        import js
        from js import document
        from pyodide.ffi import create_proxy
        import math
        from tinynmc import *

        from typing import Sequence, Iterable
        from modulo import modulo

        _PRECISION = 16

        def _encode(data, is_login=0):
            encoding = [round(value * (2 ** _PRECISION)) for value in data]

            coords_to_values = {(is_login, 0): sum([value * value for value in encoding])}
            for (index, value) in enumerate(encoding, 2):
                coords_to_values[(index, is_login)] = ((is_login * 3) - 2) * value

            return coords_to_values

        class tinybio:
            class node(tinynmc.node):
                """
                Data structure for maintaining the information associated with a node
                and performing node operations.
                """
                def authenticate(self, data):
                    """
                    Perform computation associated with a login operation.
                    """
                    return self.compute(self._signature, data)

            def preprocess(length: int, nodes: Sequence[node]):
                """
                Simulate a preprocessing phase among the collection of nodes for a workflow
                that supports registration and authentication data vectors of the specified
                length.
                """
                signature = [1, 1] + ([2] * length)
                tinynmc.preprocess(signature, nodes)
                for node in nodes:
                    setattr(node, '_signature', signature)

            def registration_request(data):
                return _encode(data, 0).keys()

            def authentication_request(data):
                return _encode(data, 1).keys()

            def registration_token(masks, data):
                return tinynmc.masked_factors(_encode(data, 0), masks)

            def authentication_token(masks, data):
                return tinynmc.masked_factors(_encode(data, 1), masks)

            def reveal(shares: Iterable[modulo]) -> float:
                """
                Reconstruct the result of the overall workflow from its shares and convert
                it into a meaningful output (as a percentage).
                """
                return int(sum(shares)) / (2 ** (2 * _PRECISION))

        def show_cutoff(s):
            _limit = 30
            return s[:(_limit - 3)] + '...' if len(s) > _limit else s

        def contribution_show(data, element_id):
            lines = []
            for (k, v) in list(data.items())[:9]:
                lines.append(show_cutoff(str(int(v))))

            element = document.getElementById(element_id)
            element.innerHTML = '<div>' + ('<br/>'.join(lines + ['...'])) + '</div>'

        def computation_show(data, element_id):
            element = document.getElementById(element_id)
            element.innerHTML = show_cutoff(str(int(data)))

        def compute_and_reveal(nodes, broadcast):
            shares = []
            for (name, node) in zip(['one', 'two', 'three'], nodes):
                result_share = node.authenticate(broadcast)
                shares.append(result_share)
                computation_show(result_share, 'node-' + name)

            result = tinybio.reveal(shares)

            document.getElementById('result-bar').style.color = '#000000'
            document.getElementById('result-bar').style.backgroundColor = '#FFFFFF'
            document.getElementById('result-bar').style.width = '100%' # percentage_str
            document.getElementById('result-bar').innerHTML = str(result)[:7]

        def run_a(_):
            document.getElementById('active').value = 'a'
            js.connectors()
            data_obama_login = list(js.getLoginUserA())
            masks = [node.masks(tinybio.authentication_request(data_obama_login)) for node in nodes]
            token_authentication = tinybio.authentication_token(masks, data_obama_login)
            contribution_show(token_authentication, 'auth_obama_login')
            compute_and_reveal(nodes, [token_registration, token_authentication])
            
        def run_b(_):
            document.getElementById('active').value = 'b'
            js.connectors()
            data_biden_login = list(js.getLoginUserB())
            masks = [node.masks(tinybio.authentication_request(data_biden_login)) for node in nodes]
            token_authentication = tinybio.authentication_token(masks, data_biden_login)
            contribution_show(token_authentication, 'auth_biden_login')
            compute_and_reveal(nodes, [token_registration, token_authentication])

        def submittedPhoto(_):
            global token_registration
            registerInput = list(js.getRegisterInput())
            masks = [node.masks(tinybio.registration_request(registerInput)) for node in nodes]
            token_registration = tinybio.registration_token(masks, registerInput)
            contribution_show(token_registration, 'auth_obama_register')
        
        token_registration = {}
        nodes = [tinybio.node(), tinybio.node(), tinybio.node()]
        tinybio.preprocess(136, nodes)
        e = document.getElementById('register')
        e.addEventListener('click', create_proxy(submittedPhoto))

        e = document.getElementById('authenticate')
        e.addEventListener('click', create_proxy(run_a))
      </py-script>
      <input id="active" type="hidden" value="none"/>
    </section>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous">
    </script>
    <script src="face-api.js"></script>
    <script>
      var registerInputValue;
      var loginUserAValue;
      var loginUserBValue;

      function getRegisterInput() {
        return registerInputValue;
      }

      function getLoginUserA() {
        return loginUserAValue;
      }

      function getLoginUserB() {
        return loginUserBValue;
      }
      const canvas_register_and_login = document.getElementById("canvas-register-and-login");
      const context_register_and_login = canvas_register_and_login.getContext("2d");
      const canvas_reconstruct = document.getElementById("canvas-reconstruct");
      const context_reconstruct = canvas_reconstruct.getContext("2d");

      function vertical(context, x1, y1, x2, y2, color) {
          context.fillStyle = color;
          context.fillRect(x1 - 1, y1, x2 - x1 + 2, y2 - y1);
      }

      function horizontal(context, x1, y1, x2, y2, color) {
          context.fillStyle = color;
          context.fillRect(x1 - 1, y1 - 2, x2 - x1 + 2, y2 - y1 + 4);
      }

      function containImages() {
          /*var preview = document.getElementById('previewImage');
          let maxHeight = Math.min(100, preview.parentElement.offsetHeight);
          if (preview.offsetHeight > maxHeight) {
            preview.style.width = ((preview.offsetWidth * maxHeight) / preview.offsetHeight) + 'px';
            preview.style.height = maxHeight + 'px';
          }*/
      }

      function connectors() {
          containImages();

          // Registration and login connectors.
          canvas_register_and_login.width = canvas_register_and_login.offsetWidth;
          let w = canvas_register_and_login.width, h = canvas_register_and_login.height;

          vertical(context_register_and_login, w/6, 0, w/6, h/2, "#CCCCCC");
          horizontal(context_register_and_login, w/6, h/2, (5*w)/6, h/2, "#CCCCCC");
          vertical(context_register_and_login, w/2, h/2, w/2, h, "#CCCCCC");
          vertical(context_register_and_login, w/6, h/2, w/6, h, "#CCCCCC");
          vertical(context_register_and_login, (5*w)/6, h/2, (5*w)/6, h, "#CCCCCC");

          const active = document.getElementById('active').value;
          if (active !== 'none') {
              const offset = 30;
              vertical(context_register_and_login, (5*w)/6 + offset, 0, (5*w)/6 + offset, (3*h)/4, "#000000");
              horizontal(context_register_and_login, w/6 + offset, (3*h)/4, (5*w)/6 + offset, (3*h)/4, "#000000");
              vertical(context_register_and_login, w/2 + offset, (3*h)/4, w/2 + offset, h, "#000000");
              vertical(context_register_and_login, w/6 + offset, (3*h)/4, w/6 + offset, h, "#000000");
              vertical(context_register_and_login, (5*w)/6 + offset, (3*h)/4, (5*w)/6 + offset, h, "#000000");
          }

          // Reconstruction connectors.
          canvas_reconstruct.width = canvas_reconstruct.offsetWidth;
          w = canvas_reconstruct.width, h = canvas_reconstruct.height;

          vertical(context_reconstruct, w/2, 0, w/2, h/2, "#0000FF");
          vertical(context_reconstruct, w/6, 0, w/6, h/2, "#0000FF");
          vertical(context_reconstruct, (5*w)/6, 0, (5*w)/6, h/2, "#0000FF");
          horizontal(context_reconstruct, w/6, h/2, (5*w)/6, h/2, "#0000FF");
          vertical(context_reconstruct, w/2, h/2, w/2, h, "#0000FF");
      }

      async function processImage(imgElement) {
        const detection = await faceapi.detectSingleFace(imgElement, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceExpressions()

        return detection
      }

      function normalizeDetectedImageCoords(processedImg) {
        const faceDetectionBox = processedImg.detection._box;
        const boundingBoxX = faceDetectionBox._x;
        const boundingBoxY = faceDetectionBox._y;
        const boundingBoxWidth = faceDetectionBox._width;
        const boundingBoxHeight = faceDetectionBox._height;

        const normalizedCoords = processedImg.landmarks._positions.map(point => {
          const normalizedX = (point._x - boundingBoxX) / boundingBoxWidth;
          let normalizedY = (point._y - boundingBoxY) / boundingBoxHeight;
          return [normalizedX, normalizedY];
        });
        return normalizedCoords.flat();
      }

      // Handle image from image uploader
      document.getElementById('imageUploader').addEventListener('change', function(event) {
          var file = event.target.files[0];
          var reader = new FileReader();

          reader.onload = function(e) {
              var img = document.getElementById('previewImage');
              img.src = URL.createObjectURL(file);
              img.onload = () => URL.revokeObjectURL(img.src);  // Free memory
              img.style.display = 'block';

              // Process the uploaded image with faceapi, then normalize image coordinates
              processImage(img).then((processedImg)=> {
                const normalized = normalizeDetectedImageCoords(processedImg);
                
                // set global variable to pass input value to pyscript
                registerInputValue = normalized;
              })
              
              containImages();
          };
          reader.readAsDataURL(file);
      });

      document.getElementById('img-auth-a').addEventListener('click', function(event) {
        document.getElementById('img-auth-a').style.border = '4px solid #0000FF';
        document.getElementById('img-auth-b').style.border = '0px solid #000000';
      });

      document.getElementById('img-auth-b').addEventListener('click', function(event) {
        document.getElementById('img-auth-a').style.border = '0px solid #000000';
        document.getElementById('img-auth-b').style.border = '4px solid #0000FF';
      });

      async function loadModels() {
        await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
        await faceapi.nets.faceLandmark68Net.loadFromUri('./models');
        await faceapi.nets.faceRecognitionNet.loadFromUri('./models');
        await faceapi.nets.faceExpressionNet.loadFromUri('./models');
        await faceapi.nets.ageGenderNet.loadFromUri('./models');   

        // process user a
        var userA = document.getElementById('img-auth-a');
        processImage(userA).then((processedImg)=> {
          const normalized = normalizeDetectedImageCoords(processedImg);
          loginUserAValue = normalized;
        })

        // process user b
        var userB = document.getElementById('img-auth-b');
        processImage(userB).then((processedImg)=> {
          const normalized = normalizeDetectedImageCoords(processedImg);
          loginUserBValue = normalized;
        })
      }

      window.onload = loadModels;
      window.onresize = connectors;
    </script>
  </body>
</html>
